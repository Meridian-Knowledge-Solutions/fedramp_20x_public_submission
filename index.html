
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FedRAMP 20x Trust Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-color: #f8fafc;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #004080;
      color: #fff;
      padding: 20px;
      text-align: center;
    }
    .banner {
      background: #e0f2fe;
      padding: 10px;
      text-align: center;
      font-size: 0.95em;
      color: #0369a1;
      font-weight: 500;
    }
    .summary {
      text-align: center;
      font-weight: 500;
      margin: 10px 0;
      color: #222;
    }
    .container {
      padding: 20px;
    }
    .filter {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    select {
      padding: 6px;
      font-size: 0.9em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 16px;
      border: 1px solid #d0d7de;
    }
    th {
      background-color: #1e3a8a;
      color: white;
    }
    tr:nth-child(even) {
      background-color: #f2f6fb;
    }
    tr:hover {
      background-color: #e6f0ff;
    }
    .status {
      font-size: 1.2em;
    }
    .meta {
      font-size: 0.8em;
      color: #555;
    }
    .icon-cli::before {
      content: "üü¢ ";
    }
    .icon-static::before {
      content: "üìÑ ";
    }
    a {
      color: #0066cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    .locked {
      color: #888;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <h1>FedRAMP 20x Trust Dashboard</h1>
  </header>
  <div class="banner">
    Transparency-first implementation of the FedRAMP 20x pilot. Last metadata update: <span id="lastUpdated">loading...</span>
  </div>
  <div class="summary" id="summaryStats">Loading validation summary...</div>
  <div class="container">
    <div class="filter">
      <label><input type="checkbox" id="filterFailed" onchange="toggleFailures()"> Show only ‚ùå failed validations</label>
      <label>Filter by KSI:
        <select id="ksiFilter" onchange="applyKsiFilter()">
          <option value="">All KSIs</option>
        </select>
      </label>
    </div>
    <table>
      <thead>
        <tr>
          <th>KSI ID</th>
          <th>Title</th>
          <th>Description</th>
          <th>Assertion</th>
          <th>Evidence</th>
          <th>Evidence Trace</th>
        </tr>
      </thead>
      <tbody id="dashboardBody"></tbody>
    </table>
  </div>

  <script>
    const SUBMISSION_URL = "https://raw.githubusercontent.com/Meridian-Knowledge-Solutions/fedramp_20x_public_submission/main/fedramp20x_submission.json";
    const METADATA_URL = "https://raw.githubusercontent.com/Meridian-Knowledge-Solutions/fedramp_20x_public_submission/main/evidence_commit_metadata.json";

    async function loadDashboard() {
      const [submissionRes, metadataRes] = await Promise.all([
        fetch(SUBMISSION_URL),
        fetch(METADATA_URL)
      ]);
      const submissionData = await submissionRes.json();
      const metadata = await metadataRes.json();
      // Begin rendering rows with fallback
      try { renderDashboard(submissionData, metadata); } catch (e) { document.getElementById('summaryStats').textContent = '‚ùå Error loading dashboard'; console.error(e); }
    }

    function renderDashboard(data, metadata) {
      const tbody = document.getElementById("dashboardBody");
      const ksiSet = new Set();
      let passedCount = 0, failedCount = 0, restrictedCount = 0;

      const updatedTimestamps = [];
      tbody.innerHTML = "";

      data.ksi_validations.forEach(ksi => {
        ksiSet.add(ksi.ksi_id);

        ksi.validation_results.forEach(result => {
          const row = document.createElement("tr");
          const passed = result.assertion === true || result.assertion === "true";
          row.setAttribute("data-passed", passed);
          row.setAttribute("data-ksi", ksi.ksi_id);

          const ref = result.evidence_reference || "";
          const meta = metadata[ref] || {};
          const shortSHA = meta.commit_sha ? meta.commit_sha.substring(0, 7) : null;
          const ts = meta.timestamp || null;
          const isStatic = !result.evidence_type || result.evidence_type === "static";

          if (ts) updatedTimestamps.push(ts);
          if (!passed) failedCount++;
          else passedCount++;

          const evidenceType = result.evidence_type === "cli_output" ? "icon-cli" : "icon-static";
          let evidenceHTML = "";
          if (ref && shortSHA) {
            if (isStatic) {
              evidenceHTML = `<span class="${evidenceType}"></span><span class="locked" title="Evidence restricted. Submit access request if needed.">üîí Evidence restricted</span><br/>
              <a class="locked" href="https://github.com/Meridian-Knowledge-Solutions/fedramp_20x_public_submission/issues/new?title=Request+Access:+${ksi.ksi_id}&body=Request+access+to:+${ref}" target="_blank">Request Access</a>`;
              restrictedCount++;
            } else {
              evidenceHTML = `<span class="${evidenceType}" title="${result.validation_method || 'CLI Validated'}"></span><a href="${ref}" target="_blank">View</a>`;
            }
          } else if (ref && !shortSHA && !passed) {
            const encodedTitle = encodeURIComponent(`Missing Evidence: ${ksi.ksi_id}`);
            const encodedBody = encodeURIComponent(`Assertion failed for:

**KSI:** ${ksi.ksi_id} - ${ksi.title}
**Description:** ${result.description}
**Evidence reference:** ${ref}`);
            const issueURL = `https://github.com/Meridian-Knowledge-Solutions/fedramp_20x_public_submission/issues/new?title=${encodedTitle}&body=${encodedBody}`;
            evidenceHTML = `<a href="${issueURL}" target="_blank">üõ† Request Clarification</a>`;
          } else {
            evidenceHTML = 'N/A';
          }

          row.innerHTML = `
            <td>${ksi.ksi_id}</td>
            <td>${ksi.title}</td>
            <td>${result.description}</td>
            <td><span class="status">${passed ? '‚úÖ' : '‚ùå'}</span></td>
            <td>${evidenceHTML}</td>`;

          const traceCell = document.createElement("td");
          if (shortSHA && ts) {
            const utcTime = new Date(ts);
            const localTime = utcTime.toLocaleString();
            traceCell.innerHTML = `üîπ SHA: ${shortSHA}<br/>‚è± UTC: ${ts.slice(0, 16).replace("T", " ")}<br/>üïí Local: ${localTime}`;
          } else {
            traceCell.innerHTML = "‚Äî";
          }
          row.appendChild(traceCell);
          tbody.appendChild(row);
        });
      });

      // Populate filter
      const filter = document.getElementById("ksiFilter");
      // Populate dropdown safely
      Array.from(ksiSet).sort().forEach(k => {
        const opt = document.createElement("option");
        opt.value = k;
        opt.textContent = k;
        filter.appendChild(opt);
      });

      // Summary counts
      document.getElementById("summaryStats").textContent =
        `Validations: ${passedCount + failedCount} | ‚úÖ Passed: ${passedCount} | ‚ùå Failed: ${failedCount} | üîí Restricted: ${restrictedCount}`;

      if (updatedTimestamps.length > 0) {
        const latest = updatedTimestamps.sort().reverse()[0];
        document.getElementById("lastUpdated").textContent = new Date(latest).toLocaleString();
      } else {
        document.getElementById("lastUpdated").textContent = "No metadata found";
      }
    }

    function toggleFailures() {
      const showOnlyFailed = document.getElementById("filterFailed").checked;
      document.querySelectorAll("#dashboardBody tr").forEach(row => {
        const passed = row.getAttribute("data-passed") === "true";
        row.style.display = showOnlyFailed && passed ? "none" : "";
      });
    }

    function applyKsiFilter() {
      const selected = document.getElementById("ksiFilter").value;
      document.querySelectorAll("#dashboardBody tr").forEach(row => {
        const rowKsi = row.getAttribute("data-ksi");
        row.style.display = !selected || rowKsi === selected ? "" : "none";
      });
    }

    loadDashboard();
  </script>
</body>
</html>
